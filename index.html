<style>
    /* 手機圖表尺寸 */
    @media (max-width: 767px) {
        .chart-container {
            height: 250px; /* 原本是 300px，縮小一點 */
        }
    }
</style>

<script>
    // ===== 修改格式化數字為 K 單位 =====
    function formatNumber(num) {
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toLocaleString();
    }

    // ===== 修改圖表初始化部分 =====
    function initChart(filteredData, metric) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        if (mainChart) {
            mainChart.destroy();
        }

        const datasets = [];
        if (metric === 'all' || metric === 'performance') {
            datasets.push({
                label: '業績',
                data: filteredData.map(item => item.performance),
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            });
        }
        if (metric === 'all' || metric === 'adCost') {
            datasets.push({
                label: '廣告費用',
                data: filteredData.map(item => item.adCost),
                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                yAxisID: 'y'
            });
        }
        if (metric === 'all' || metric === 'orders') {
            datasets.push({
                label: '總單量',
                data: filteredData.map(item => item.orders),
                type: 'line',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                pointRadius: 3,
                yAxisID: 'y1'
            });
        }

        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filteredData.map(item => item.month),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNumber(value); // 金額顯示 K 單位
                            }
                        },
                        title: { display: true, text: '金額 (K 元)' }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: '單量' }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label + ': ';
                                if (context.dataset.label === '總單量') {
                                    label += context.raw + '單';
                                } else {
                                    label += formatNumber(context.raw) + '元';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        currentScale = 1;
    }
</script>
